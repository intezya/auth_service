# generate_tracing.go â€“ Tracing Wrapper Generator

A utility for automatically generating tracing wrappers around Go structs and their methods.

<!-- TOC -->
- [Features](#features)
- [Installation & Usage](#installation--usage)
    - [Main Flags](#main-flags)
    - [Usage Examples](#usage-examples)
- [gRPC-Specific Features](#grpc-specific-features)
- [Generated Code Structure](#structure-of-the-generated-code)
- [How It Works](#how-it-works)
- [Limitations](#limitations)
- [Integration](#integration)
<!-- /TOC -->


## Features

- Auto-generation of tracing wrappers for any struct
- Supports interfaces from different packages
- Correct handling of named imports (e.g., `authpb "github.com/example/auth"`)
- Automatically embeds `mustEmbed` interfaces for gRPC services
- Supports embedded interfaces in wrapper structs
- Smart import management (only adds used imports)
- Recursive struct search in directories

## Installation & Usage

### Main Flags

```bash
# Required
-struct string            # Name of the struct to wrap
-file string              # Go file containing the struct (optional; can be found via search)

# Interface config
-interface string         # Interface name (default = struct name)
-interface-pkg string     # Interface package (if different from struct's)

# Struct config
-struct-pkg string        # Struct package (if different from output package)

# Output config
-output string            # Output file (default: <struct>_tracing.go)
-package string           # Output package name (default: same as input)

# Tracing
-tracer string            # Tracer import path (default: github.com/intezya/auth_service/internal/infrastructure/metrics/tracer)

# Search
-search-dir string        # Directory to search for the struct (default: ".")
-recursive                # Enable recursive search

# Interface embedding
-embed string             # Comma-separated list of interfaces to embed
-embed-pkg string         # Comma-separated list of packages for embedded interfaces

# Constructor
-use-constructor bool     # Use constructor of original struct (default: true)
-constructor-name string  # Original struct constructor name (default: NewCaptalizedStructName)

# Debug
-verbose                  # Verbose output
```

## Usage Examples

### 1. Simple struct in the same package

```bash
go run ./tools/generate_tracing.go -struct=UserService -file=service.go
```

### 2. gRPC controller with named imports

```bash
go run ./tools/gen_tracing.go \
  -struct=authController \
  -interface=AuthServiceServer \
  -interface-pkg=github.com/intezya/auth_service/protos/go/auth \
  -file=./internal/adapters/grpc/controller.go \
  -output=./internal/adapters/grpc/controller_tracing.go \
  -embed=UnimplementedAuthServiceServer
```

### 3. Struct from another package

```bash
go run ./tools/generate_tracing.go \
  -struct=DatabaseRepo \
  -interface=Repository \
  -struct-pkg=github.com/example/internal/repo \
  -interface-pkg=github.com/example/internal/domain \
  -output=repo_tracing.go
```

### 4. Searching for a struct in a directory

```bash
go run ./tools/generate_tracing.go \
  -struct=PaymentService \
  -search-dir=./internal/services \
  -recursive
```

### 5. Multiple embedded interfaces

```bash
go run ./tools/generate_tracing.go \
  -struct=myGrpcServer \
  -interface=MyServiceServer \
  -interface-pkg=github.com/example/proto \
  -embed="UnimplementedMyServiceServer,ValidationInterface" \
  -embed-pkg="github.com/example/proto,github.com/example/validation"
```

(also see the taskfile.yaml in root of repository)

## gRPC-Specific Features

### Auto-Embedding mustEmbed Interfaces

The generator automatically detects and embeds required gRPC interfaces:

```go
// Original struct
type authController struct {
    authpb.UnimplementedAuthServiceServer  // already embedded
    authService service.AuthService
}

// Generated wrapper
type authControllerWithTracing struct {
    wrapped authpb.AuthServiceServer
    authpb.UnimplementedAuthServiceServer  // auto-embedded
}
```

### Named Import Handling

The generator properly handles named imports and aliases:

```go
// Input file
import (
    authpb "github.com/intezya/auth_service/protos/go/auth"
)

// Generated file
import (
    authpb "github.com/intezya/auth_service/protos/go/auth"  // alias preserved
)

func (t *authControllerWithTracing) Register(
    ctx context.Context, 
    request *authpb.AuthenticationRequest,  // uses correct alias
) (*authpb.Empty, error) {
    // ...
}
```

## Structure of the Generated Code

The generator produces:

1. **Wrapped struct** with a `wrapped` field of the interface type
2. **Constructor** `New<Struct>WithTracing`
3. **Wrapped methods** for all public methods of the original struct
4. **Tracing** for methods with `context.Context` as the first parameter
5. **Embedded interfaces** if needed

### Example Output

```go
// Code generated by tracing-gen. DO NOT EDIT.

package grpc

import (
    "context"
    tracer "github.com/intezya/auth_service/internal/infrastructure/metrics/tracer"
    authpb "github.com/intezya/auth_service/protos/go/auth"
)

type authControllerWithTracing struct {
    wrapped authpb.AuthServiceServer
    authpb.UnimplementedAuthServiceServer
}

func NewAuthControllerWithTracing(wrapped authpb.AuthServiceServer) authpb.AuthServiceServer {
    return &authControllerWithTracing{
        wrapped: wrapped,
    }
}

func (t *authControllerWithTracing) Register(ctx context.Context, request *authpb.AuthenticationRequest) (*authpb.Empty, error) {
    ctx, span := tracer.StartSpan(ctx, "AuthController.Register")
    defer span.End()
    return t.wrapped.Register(ctx, request)
}
```

## How It Works

1. **Parse input file** - Analyze the AST to locate the struct and its methods
2. **Analyze imports** - Track named imports and their aliases
3. **Locate interfaces** - Identify the main and embedded interfaces
4. **Generate code** - Build the wrapper with tracing logic
5. **Optimize imports** - Removes unused ones
6. **Format output** - Run `go fmt` on result

## Limitations

- Handles only public methods
- Tracing is added only for methods with `context.Context` as the first parameter
- Generics (Go 1.18+) are not supported
- The struct must implements the specified interface

## Integration

```bash
# Taskfile
version: '3'

tasks:
  generate_tracing:
    desc: "Generate tracing wrappers for services"
    cmds:
      - |
        go run ./tools/generate_tracing.go \
          --struct=authService \
          --interface=AuthService \
          --file=./internal/application/service/auth_service.go \
          --output=./internal/application/service/auth_service_tracing.go
    
# go:generate directive
//go:generate go run ./tools/generate_tracing.go -struct=UserService -file=service.go ...
```
